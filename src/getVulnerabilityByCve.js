const requestWithDefaults = require('./requestWithDefaults');
const { getTokenFromCache } = require('./tokenCache');
const { getLogger } = require('./logger');
const { RequestError } = require('./responses');

/**
 * Fetches vulnerability details from CrowdStrike Spotlight API for a given CVE ID.
 * @param {string} cveId - The CVE ID to filter on (e.g., 'CVE-2023-12345').
 * @param {object} options - Integration options (auth, etc).
 * @returns {Promise<object>} - Structured API response data
 */
async function getVulnerabilityByCve(cveId, options) {
  const Logger = getLogger();
  // Ensure token is set
  const token = getTokenFromCache(options);
  if (!token) {
    throw new RequestError('No access token available', 401, null, {});
  }

  const filter = `cve.id:['${cveId}']`;
  const url = `${
    options.url
  }/spotlight/combined/vulnerabilities/v1?filter=${encodeURIComponent(
    filter
  )}&facet=host_info&facet=cve&facet=remediation&facet=evaluation_logic`;
  const requestOptions = {
    method: 'GET',
    url,
    headers: {
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    json: true
  };

  try {
    Logger.trace({ requestOptions }, 'Requesting vulnerability data');
    const response = await requestWithDefaults.request(requestOptions);
    if (!response || !response.body) {
      throw new RequestError(
        'No response body',
        response.statusCode,
        response.body,
        requestOptions
      );
    }
    Logger.trace({ response: response.body }, 'Vulnerability API Response');
    return {
      vulnerabilities: response.body.resources || [],
      statusCode: response.statusCode
    };
  } catch (error) {
    Logger.error({ error }, 'Error fetching vulnerability data');
    throw error;
  }
}

module.exports = {
  getVulnerabilityByCve
};
