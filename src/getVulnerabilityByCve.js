const authenticatedRequest = require('./authenticatedRequest');
const { getLogger } = require('./logger');
const { RequestError } = require('./responses');

/**
 * Fetches vulnerability details from CrowdStrike Spotlight API for a given CVE ID.
 * @param {string} cveId - The CVE ID to filter on (e.g., 'CVE-2023-12345').
 * @param {object} options - Integration options (auth, etc).
 * @returns {Promise<object>} - Structured API response data
 */
async function getVulnerabilityByCve(cveId, options) {
  const Logger = getLogger();

  const filter = `cve.id:['${cveId}']`;
  const requestOptions = {
    method: 'GET',
    url: `${options.url}/spotlight/combined/vulnerabilities/v1`,
    qs: {
      filter,
      facet: ['host_info', 'cve', 'remediation', 'evaluation_logic']
    },
    json: true
  };

  try {
    const response = await authenticatedRequest(requestOptions, options);
    if (!response || !response.body) {
      throw new RequestError(
        'No response body',
        response.statusCode,
        response.body,
        requestOptions
      );
    }
    Logger.trace({ response: response.body }, 'Vulnerability API Response');
    return {
      vulnerabilities: response.body.resources || [],
      statusCode: response.statusCode
    };
  } catch (error) {
    Logger.error({ error }, 'Error fetching vulnerability data');
    throw error;
  }
}

module.exports = {
  getVulnerabilityByCve
};
